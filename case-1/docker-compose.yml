services:
  ray-head:
    image: rayproject/ray:latest
    container_name: ray-head
    command: >
      ray start --head
      --dashboard-host=0.0.0.0
      --block
    ports:
      - "8080:8080" # API server
      - "6379:6379" # Ray head node
      - "8265:8265" # Ray dashboard
    environment:
      - RAY_DISABLE_IMPORT_WARNING=1
    restart: unless-stopped
    networks:
      - ray-network

  ray-worker-gpu-1:
    image: rayproject/ray:latest-gpu
    container_name: ray-worker-gpu-1
    command: >
      ray start
      --address=ray-head:6379
      --block
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - RAY_DISABLE_IMPORT_WARNING=1
    restart: unless-stopped
    depends_on:
      - ray-head
    networks:
      - ray-network

  ray-worker-gpu-2:
    image: rayproject/ray:latest-gpu
    container_name: ray-worker-gpu-2
    command: >
      ray start
      --address=ray-head:6379
      --block
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["1"]
              capabilities: [gpu]
    depends_on:
      - ray-head
      - ray-worker-gpu-1
    networks:
      - ray-network

volumes:
  ray_logs:

networks:
  ray-network:
    driver: bridge
